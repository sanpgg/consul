<% if @budget.is_new? %>
    <div class="container mt-5 mb-4 wrapper-resultados">
      <% if !params[:id].present? %>
        <div class="row pb-3 d-none d-lg-block mt-1 mb-3">
            <div class="col-md-12">
                <div class="controls-btn-filters">
                    <ul class="d-flex justify-content-between">
                        <li>
                            <a href="<%= budget_results_path(@budget) %>?s=all">
                                <span class="btn-filter"><i class="fa-solid fa-list-ul"></i></span>
                                <span class="title">Todas</span>
                            </a>
                        </li>
                        <% new_sectors.each do |s| %>
                            <li class="<%= (params[:s] == s[:short_name]) ? 'active' : '' %>">
                                <a href="<%= budget_results_path(@budget) %>?s=<%= s[:short_name]%>">
                                  <span class="btn-filter"><%= s[:short_name] %></span>
                                  <span class="title"><%= s[:large_name] %></span>
                                </a>
                            </li>
                        <% end %>
                        <li>
                            <a href="<%= budget_results_path(@budget) %>?size=large">
                                <span class="btn-filter format-mdp">$12.5 mdp</span>
                                <span class="title">Proyecto Sectorial</span>
                            </a>
                        </li>
                        <li>
                            <a href="<%= budget_results_path(@budget) %>?size=medium">
                                <span class="btn-filter format-mdp">$1 mdp</span>
                                <span class="title">Proyecto Comunitario</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
      <% end %>
        <div class="row justify-content-center">
          <div class="col-md-12 col-lg-8 col-lx-8">
              <h1 class="text-center"><span>Resultados</span> de presupuestos participativos</h1>
              <div class="content-search-nav position-relative filter-ballot">
                <form class="filter-ballot">
                  <div class="mb-3">
                      <span class="icon"><i class="fa-solid fa-magnifying-glass"></i></span>
                      <%= form_tag budgets_path, method: :get, id: "search-form" do %>
                          <%= text_field_tag :query, params[:query], placeholder: "Buscar", class: "form-control" %>
                      <% end %>
                  </div>
                </form>
                <!-- <button class="setting" data-bs-toggle="modal" data-bs-target="#searchModal">
                  <svg width="24px" height="18px" viewBox="0 0 24 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                              <g id="Buscador---1" transform="translate(-656.000000, -47.000000)" stroke="#071110">
                                  <g id="Group-3" transform="translate(657.523810, 48.714286)">
                                      <g id="Group-14" transform="translate(5.434783, 1.955556)" stroke-linecap="round" stroke-linejoin="round" stroke-width="4">
                                          <line x1="0" y1="0.523809524" x2="14.4927536" y2="0.523809524" id="Path-19"></line>
                                      </g>
                                      <g id="Group-15" transform="translate(1.594203, 9.777778)">
                                          <line x1="0" y1="2.44444444" x2="14.5755694" y2="2.44444444" id="Path-19-Copy" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></line>
                                          <ellipse id="Oval-Copy-4" stroke-width="2" fill="#FFFFFF" cx="16.9668737" cy="2.44444444" rx="2.39130435" ry="2.44444444"></ellipse>
                                      </g>
                                      <ellipse id="Oval" stroke-width="2" fill="#FFFFFF" cx="2.39130435" cy="2.44444444" rx="2.39130435" ry="2.44444444"></ellipse>
                                  </g>
                                  <ellipse id="Oval" stroke-width="2" fill="#FFFFFF" cx="2.39130435" cy="2.44444444" rx="2.39130435" ry="2.44444444"></ellipse>
                              </g>
                          </g>
                      </g>
                  </svg>
                </button> -->
              </div>

              <div class="content-resultados">
                <h3 class="text-center mb-4">Conoce los resultados de la votación</h3>
                <div class="d-flex justify-content-between justify-content-lg-end align-items-end mb-4">
                  <div class="content-sectores position-relative d-block d-lg-none">
                    <button class="btn-filter-sector py-3 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSesctores" aria-expanded="false" aria-controls="collapseSesctores">
                        Sectores <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <ul id="collapseSesctores" class="nav-categories collapse multi-collapse position-absolute">  
                        <% new_sectors.each do |s| %>
                            <li class="<%= (params[:s] == s[:short_name]) ? 'active' : '' %>">
                                <a href="<%= budget_results_path(@budget) %>?s=<%= s[:short_name]%>">
                                  <%= s[:short_name] %> - <%= s[:large_name] %>
                                </a>
                            </li>
                        <% end %>
                        <li>
                            <a href="<%= budget_results_path(@budget) %>?size=large">
                                $12.5 mdp - Sectorial
                            </a>
                        </li>
                        <li>
                            <a href="<%= budget_results_path(@budget) %>?size=medium">
                                $1 mdp - Comunitario
                            </a>
                        </li>
                    </ul>
                  </div>
                  <div class="content-check-winner" style="cursor: pointer;">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="no_ganadoras" <%= 'checked' if params[:status] == 'inw' %>>
                      <label class="form-check-label" for="no_ganadoras">Mostrar no ganadoras</label>
                    </div>
                  </div>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <th>Proyecto</th>
                      <th>Decide Fest</th>
                      <th>Votos en línea</th>
                      <th>Total de votos</th>
                      <th>Estatus de seguimiento</th>
                    </thead>

                    <tbody>
                      <% @investments.each do |investment| %>
                        <tr>
                          <td>
                            <% if investment.feasible? %>
                              <% if investment.winner? %>
                                <div class="d-flex icon-result align-items-center">
                                  <svg width="22px" height="23px" viewBox="0 0 22 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                          <g id="Resultados" transform="translate(-302.000000, -575.000000)" fill="#BDDD35" fill-rule="nonzero">
                                              <path d="M313.000153,575 L316.025207,577.242116 L319.798277,577.196341 L320.91992,580.7784 L324,582.946172 L322.789581,586.5 L324,590.053219 L320.91992,592.220991 L319.798277,595.80305 L316.025207,595.757275 L313.000153,598 L309.974487,595.757275 L306.201417,595.80305 L305.079773,592.220991 L302,590.053219 L303.209884,586.5 L302,582.946172 L305.079773,580.7784 L306.201417,577.196341 L309.974487,577.242116 L313.000153,575 Z M318.770056,583.729045 C319.598744,582.625939 317.983506,581.313759 317.154512,582.417183 L317.154512,582.417183 L311.917701,589.371022 L308.727833,586.354917 C307.729774,585.410863 306.347839,586.990807 307.345309,587.934543 L307.345615,587.934289 L311.352241,591.722672 C311.814382,592.159755 312.538483,592.067187 312.890392,591.536597 L312.890392,591.536597 Z" id="Shape"></path>
                                          </g>
                                      </g>
                                  </svg>
                                  <%= investment.draw ? "<p>Ganador por deliberación</p>".html_safe : "<p>Ganador</p>".html_safe %>
                                </div>
                              <% else %>
                                <% if investment.draw? %>
                                  <div class="d-flex icon-result align-items-center">
                                    <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <g id="Resultados" transform="translate(-246.000000, -737.000000)" fill="#879B9A" fill-rule="nonzero">
                                                <g id="Group" transform="translate(246.000000, 737.000000)">
                                                    <path d="M18.125,10 C18.125,14.4873136 14.4873136,18.125 10,18.125 C5.51268641,18.125 1.875,14.4873136 1.875,10 C1.875,5.51268641 5.51268641,1.875 10,1.875 C14.4873136,1.875 18.125,5.51268641 18.125,10 Z M0,10 C0,15.5228475 4.4771525,20 10,20 C15.5228475,20 20,15.5228475 20,10 C20,4.4771525 15.5228475,0 10,0 C4.4771525,0 0,4.4771525 0,10 Z M9.0625,4.6875 L9.0625,10 C9.0625,10.3125 9.21875,10.6054688 9.48046875,10.78125 L13.2304688,13.28125 C13.6601562,13.5703125 14.2421875,13.453125 14.53125,13.0195312 C14.8203125,12.5859375 14.703125,12.0078125 14.2695312,11.71875 L10.9375,9.5 L10.9375,4.6875 C10.9375,4.16796875 10.5195312,3.75 10,3.75 C9.48046875,3.75 9.0625,4.16796875 9.0625,4.6875 Z" id="Shape"></path>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                    <p>Empate - En deliberación</p>
                                  </div>
                                <% else %>
                                  <div class="d-flex mb-1 icon-result align-items-center">
                                    <svg width="22px" height="23px" viewBox="0 0 22 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <g id="Resultados" transform="translate(-302.000000, -891.000000)" fill-rule="nonzero">
                                                <g id="Group-13" transform="translate(302.000000, 891.000000)">
                                                    <polygon id="Shape-Copy-2" fill="#FF4254" points="11.0001531 0 14.0252066 2.24211604 17.7982773 2.19634081 18.9199204 5.77839988 22 7.94617188 20.7895806 11.5 22 15.0532194 18.9199204 17.2209914 17.7982773 20.8030504 14.0252066 20.7572752 11.0001531 23 7.97448724 20.7572752 4.20141653 20.8030504 3.07977347 17.2209914 0 15.0532194 1.20988367 11.5 0 7.94617188 3.07977347 5.77839988 4.20141653 2.19634081 7.97448724 2.24211604"></polygon>
                                                    <g id="Group" transform="translate(7.000000, 8.000000)" fill="#FFFFFF">
                                                        <path d="M7.76323598,1.36623458 C8.07558957,1.05388099 8.07558957,0.546618772 7.76323598,0.234265188 C7.4508824,-0.0780883961 6.94362018,-0.0780883961 6.63126659,0.234265188 L4,2.86803061 L1.36623458,0.236764017 C1.05388099,-0.0755895674 0.546618772,-0.0755895674 0.234265188,0.236764017 C-0.0780883961,0.549117601 -0.0780883961,1.05637982 0.234265188,1.36873341 L2.86803061,4 L0.236764017,6.63376542 C-0.0755895674,6.94611901 -0.0755895674,7.45338123 0.236764017,7.76573481 C0.549117601,8.0780884 1.05637982,8.0780884 1.36873341,7.76573481 L4,5.13196939 L6.63376542,7.76323598 C6.94611901,8.07558957 7.45338123,8.07558957 7.76573481,7.76323598 C8.0780884,7.4508824 8.0780884,6.94362018 7.76573481,6.63126659 L5.13196939,4 L7.76323598,1.36623458 Z" id="Path"></path>
                                                    </g>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                    <p>No ganador</p>
                                  </div>
                                <% end %>
                              <% end %>
                            <% else %>
                              <div class="d-flex mb-1 icon-result align-items-center">
                                <svg width="21px" height="21px" viewBox="0 0 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <g id="Resultados" transform="translate(-303.000000, -1241.000000)" stroke-width="2">
                                            <g id="Group-6" transform="translate(304.000000, 1242.000000)">
                                                <circle id="Oval" stroke="#879B9A" cx="8.5" cy="8.5" r="8.5"></circle>
                                                <line x1="17" y1="0" x2="0" y2="18.4963226" id="Path-24" stroke="#879B9A" stroke-linecap="round"></line>
                                                <line x1="19" y1="0" x2="2" y2="18.4963226" id="Path-24-Copy" stroke="#FFFFFF" stroke-linecap="round"></line>
                                                <line x1="17" y1="0" x2="0" y2="18.4963226" id="Path-24" stroke="#879B9A" stroke-linecap="round"></line>
                                            </g>
                                        </g>
                                    </g>
                                </svg>
                                <p>No electo</p>
                              </div>
                            <% end %>
                            <%= investment.author.sector %> - <%= investment.title %><br/>
                            <%= investment.size == 'large' ? "<span class='mt-3 tag-td-size'>Sectorial</span>".html_safe : "<span class='mt-3 tag-td-size'>Comunitario</span>".html_safe %>  
                          </td>
                          <td><%= investment.ballot_offline_count %></td>
                          <td><%= Budget::Ballot::Line.counter(investment.id) %></td>
                          <td><%= investment.total_votes_v2 %></td>
                          <td>
                            <h5 class="pb-2">Por actualizar</h5>
                            <%= link_to budget_investment_path(investment.budget_id, investment.id), class: "btn-style-3 d-inline-block py-1 px-2"  do %>
                              Ver <i class="fa-solid fa-arrow-right"></i>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
          </div><!--.col-md-12-->
        </div><!--.row-->
    </div><!--.container-->
  
    <!-- Modal Reusltados -->
    <div class="modal fade" id="searchModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header justify-content-end">
            <button class="text-right" data-bs-dismiss="modal" aria-label="Close">
              <svg width="21px" height="21px" viewBox="0 0 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                  <g id="Buscador---Filtros" transform="translate(-964.000000, -79.000000)" stroke="#FFFFFF" stroke-width="2">
                    <g id="Group" transform="translate(965.000000, 80.000000)">
                      <line x1="0" y1="19" x2="19" y2="0" id="Path-5-Copy-2"></line>
                      <line x1="0" y1="0" x2="19" y2="19" id="Path-5-Copy-3"></line>
                    </g>
                  </g>
                </g>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <form id="filters-form">
              <div class="mb-3">
                <input name="query" type="text" placeholder="Buscar proyecto">
              </div>
              <div class="title-desc pb-2">
                <h3 class="mb-2">Sugerencias de busqueda</h3>
                <p>Puedes realizar búsquedas por: número de <strong>ID de proyecto</strong>, nombre del <strong>ponente</strong>, localidad o <strong>sector</strong>.</p>
              </div>
              
              <div class="content-filters">
                <h3>Filtros</h3>
                
                <div id="sizes">
                  <h4 class="mt-4 mb-2">Filtrar por tipo de proyectos</h4>

                  <input type="hidden" name="size" id="size-filter">

                  <% new_sizes.each do |s| %>
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <label for="<%= s[:short_name] %>"><%= s[:large_name].html_safe %></label>
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="<%= s[:short_name] %>" data-size="<%= s[:short_name] %>">
                        </div>
                      </div>
                    </div>
                  <% end %>

                </div>

                <div id="status" style="display: none;">
                  <h4 class="mt-4">Filtrar por evaluación de proyecto:</h4>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <label for="proyecto_ganador">Proyectos Ganadores</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input status-cb" type="checkbox" value="w" id="proyecto_ganador">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <label for="proyecto_factible">Proyectos Factibles</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input status-cb" type="checkbox" value="f" id="proyecto_factible">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <label for="proyecto_no_factible">Proyectos No Factibles</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input status-cb" type="checkbox" value="uf" id="proyecto_no_factible">
                      </div>
                    </div>
                  </div>
                </div>

                <input type="hidden" name="status" value="">

                <div class="mb-3">
                  <h4 class="mb-2">Categorías</h4>
                  <div class="content-categorias">
                    <input type="hidden" name="categorias">
                    <ul id="select-categories" class="d-flex flex-wrap">
                      <li>
                        <a data-cat="-Movilidad">Movilidad</a>
                      </li>
                      <li>
                        <a data-cat="-Inclusión">Inclusión</a>
                      </li>
                      <li>
                        <a data-cat="-Educación">Educación</a>
                      </li>
                      <li>
                        <a data-cat="-Medio ambiente">Medio ambiente</a>
                      </li>
                      <li>
                        <a data-cat="-Cultura y deportes">Cultura y deportes</a>
                      </li>
                      <li>
                        <a data-cat="-Seguridad">Seguridad</a>
                      </li>
                      <li>
                        <a data-cat="-Impulso económico">Impulso económico</a>
                      </li>
                      <li>
                        <a data-cat="-Parques y jardines">Parques y jardines</a>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <%# <a class="quit-filter" href="#">Quitar Filtros</a> %>
                  <button class="btn-black font-16 py-2 px-3" type="submit">Aplicar Filtros</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div><!--.modal-->
<% else %> <!--[results]-->
  <% provide :title, t("budgets.results.page_title", budget: @budget.name) %>
  <% content_for :meta_description do %>
    <%= @budget.description_for_phase('finished') %>
  <% end %>
  <% provide :social_media_meta_tags do %>
    <%= render "shared/social_media_meta_tags",
                social_url: budget_results_url(@budget),
                social_title: @budget.name,
                social_description: @budget.description_for_phase('finished') %>
  <% end %>
  <% content_for :canonical do %>
    <%= render "shared/canonical", href: budget_results_url(@budget) %>
  <% end %>

  <div class="container pt-4">
    <div id="budget_heading">
      <div class="row">
        <div class="col-md-12">
          <%= back_link_to budgets_path %>
          <h2 class="margin-top">
            <%= t("budgets.results.heading") %><br>
            <span><%= @budget.name %></span>
          </h2>
        </div>
      </div>
    </div>

    <div class="row margin-top">
      <div class="col-md-12">
        <ul class="tabs">
          <li class="tabs-title is-active">
            <span class="show-for-sr"><%= t("shared.you_are_in") %></span>
            <%= link_to t("budgets.results.link"), budget_results_path(@budget), class: "is-active" %>
          </li>
          <li class="tabs-title">
            <%= link_to t("budgets.executions.link"), budget_executions_path(@budget) %>
          </li>
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 col-lg-2">
        <h3 class="margin-bottom">
          <%= t("budgets.results.heading_selection_title") %>
        </h3>
        <ul class="menu vertical no-margin-top no-padding-top">
          <% @budget.headings.joins("LEFT JOIN colonia c ON c.id = budget_headings.suburb_id").order('group_id DESC, c.sector, name').each do |heading| %>
            <% if  heading.htype == "sector" %>
              <li>
                <%= link_to heading.name,
                            budget_results_path(@budget, heading_id: heading.to_param),
                            class: heading.to_param == @heading.to_param ? 'is-active' : '' %>
              </li>
            <% else %>
              <li>
                <%= link_to "#{Colonium.find_by(id: heading.suburb_id)&.sector} - #{heading.name}",
                            budget_results_path(@budget, heading_id: heading.to_param),
                            class: heading.to_param == @heading.to_param ? 'is-active' : '' %>
              </li>
            <% end %>
          <% end %>
        </ul>
      </div>

      <div class="col-md-9 col-lg-10">
        <%= link_to t("budgets.results.show_all_link"), "#",
                    class: "js-toggle-link button hollow margin-bottom float-right-medium",
                    data: {'toggle-selector' => '.js-discarded',
                          'toggle-text' => t("budgets.results.hide_discarded_link")} %>

        <%= render 'results_table', results_type: :compatible,
                                    title: @heading.name,
                                    heading_price: @heading.price,
                                    investments: @investments.compatible %>

        <% if @investments.incompatible.present? %>
          <%= render 'results_table', results_type: :incompatible,
                                      title: t("budgets.results.incompatibles"),
                                      heading_price: @heading.price,
                                      investments: @investments.incompatible %>
        <% end %>

        <p>
          <%= link_to budget_url(@budget) do %>
            <small><%= t("budgets.results.investment_proyects") %></small>
          <% end %><br>
          <%= link_to budget_url(@budget, filter: 'unfeasible') do %>
            <small><%= t("budgets.results.unfeasible_investment_proyects") %></small>
          <% end %><br>
        </p>
      </div>
    </div>
  </div>
<% end %>

<script>
  $(document).ready(function() {
    $('#no_ganadoras').change(function() {
        var isChecked = $(this).is(':checked');

        var noWinnerIncludesParam = '?status=inw';

        var append = '';

        var sector = "<%= params[:s] %>";

        if(sector !== "")
        {
          append = append + 's=' + sector;
        }

        if(isChecked === true)
        {
          window.location.href = window.location.href.split('?')[0] + noWinnerIncludesParam + '&' + append;
        }
        else
        {
          window.location.href = window.location.href.split('?')[0] + '?' + append;
        }
    });
});
</script>
